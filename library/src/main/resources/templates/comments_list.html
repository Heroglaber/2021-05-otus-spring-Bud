<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>edit book</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="stylesheet" th:href="@{/css/bootstrap.css}">
</head>
<body>
    <div id="wrapper">
        <div id="header">
            <h2>Comments</h2>
        </div>
    </div>
    <div class="w-25 p-3">
        <h3>Watch comments</h3>
            <table class="table table-striped">
                <tbody>
                    <input type="hidden" th:field="${book.id}" id="id">
                    <tr th:object="${book}">
                        <td><label for="bookTitle">Enter book title: </label></td>
                        <td><input class="form-control" type="text" th:placeholder="*{title}" th:field="*{title}" id="bookTitle"/></td>
                    </tr>
                    <tr th:object="${book}">
                        <table class="dynamic-update-tables table table-striped mb-0">
                            <tbody id="dynamicTableAuthors">
                            <tr th:fragment="authors" th:each="author,authorStat : ${book.authors}">
                                <input style="display:none;" th:field="${book.authors[__${authorStat.index}__].id}" id="authorId">
                                <td style="display:none;" th:text="${authorStat.count}">1</td>
                                <td>
                                    <input type="text" th:placeholder="${book.authors[__${authorStat.index}__].name}"
                                           th:field="${book.authors[__${authorStat.index}__].name}" />
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </tr>
                    <tr th:object="${book}">
                        <table class="dynamic-update-tables table table-striped mb-0">
                            <tbody id="dynamicTableGenres">
                            <tr th:fragment="genres" th:each="genre,genreStat : ${book.genres}">
                                <input style="display:none;" th:field="${book.genres[__${genreStat.index}__].id}" id="genreId">
                                <td th:text="${genreStat.count}">1</td>
                                <td>
                                    <input class="form-control" type="text" th:placeholder="${book.genres[__${genreStat.index}__].name}"
                                           th:field="${book.genres[__${genreStat.index}__].name}" />
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </tr>
                    <tr>
                        <table th:object="${comments}" class="dynamic-update-tables table table-striped mb-0">
                            <tbody>
                            <tr th:if="${comments.isEmpty()}">
                                <td colspan="2"> No comments found for this book. </td>
                            </tr>
                            <tr th:each="comment,commentStat : ${comments}">
                                <td th:text="${comment.message}">message</td>
                                <td th:text="${comment.id}" id="commentId">id</td>
                                <td th:text="${commentStat.count}">1</td>
                                <td>
<!--                                    <input class="form-control" type="text" th:placeholder="${comment.message}"-->
<!--                                           th:field="${comment.message}" />-->
                                </td>
                                                                <td>
                                                                    <button type="button" class="btn btn-primary" name="deleteComment"
                                                                            th:with="deleteLink = @{/comments/delete/{id}(id = ${comment.id})}"
                                                                            th:onclick="sendDelete([[${deleteLink}]])">Delete</button>
                                                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </tr>
                </tbody>
            </table>
    </div>

    <script type="text/javascript"
            th:src="@{/webjars/jquery/3.6.0/jquery.min.js}"></script>

    <script>
        $(document).ready(function () {

            // Invoke the corresponding URL to update the dynamic fields section using Ajax
            $('.dynamic-update-tables').on('click', 'button[data-dynamic-update-tables-url]', function () {
                //event event.preventDefault();
                let url = $(this).data('dynamic-update-tables-url');
                let tableId = $(this).attr('table-id');

                // adding the row index, needed when deleting a dynamic row
                let formData = $('form').serializeArray();
                let param = {};
                param["name"] = $(this).attr('name');
                param["value"] = $(this).val();
                formData.push(param);

                param = {};
                param["name"] = 'viewName';
                param["value"] = 'edit_form';
                formData.push(param);

                // updating the dynamic section
                $('#' + tableId).load(url, formData);
            });

            // autodismiss alerts
            window.setTimeout(function() {
                $(".alert").fadeTo(500, 0).slideUp(500, function(){
                    $(this).remove();
                });
            }, 4000);
        });

        function sendDelete(url) {
            if(!(confirm('Are you sure you want to delete this book?'))) return false;
            var xhttp = new XMLHttpRequest();
            xhttp.open("DELETE", url, true);
            xhttp.onload = function () {
                let responseURL = xhttp.responseURL;
                console.log("Redirecting to:", responseURL);
                window.location.replace(responseURL);
            };
            xhttp.send();
        }
    </script>
</body>
</html>